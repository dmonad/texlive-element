<link rel="import" href="../polymer/polymer.html">
<script src="../s-promisejs/promise.min.js"></script>
<script src="../texlive.js/pdftex.js"></script>

<!--
# &lt;texlive-element&gt;  <iframe src="https://ghbtns.com/github-btn.html?user=dmonad&repo=texlive-element&type=star&count=true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>
> Polymer WebComponent for compiling latex in your browser using [texlive.js](https://github.com/manuels/texlive.js)!

@demo demo/index.html 
-->

<dom-module id="texlive-element">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  </template>

  <script>
    Polymer({
      is: 'texlive-element',
      ready: function () {
      },
      properties: {
        /**
         * LaTeX source
         */
        source: {
          type: String,
          observer: '_observeSource'
        },
        /**
         * Url to pdf file. This is actually a binary file encoded in a url
         */
        pdf: {
          type: String,
          notify: true
        },
        /**
         * Path to pdftex-worker
         */
        pdftexWorkerPath: {
          type: String,
          value: '/bower_components/texlive.js/pdftex-worker.js'
        },
        /**
         * Texlive log output
         */
        log: {
          type: String,
          value: '',
          notify: true
        },
        /**
         * Whether this element is still processing a request
         */
        running: {
          type: Boolean,
          value: false,
          notify: true
        },
        /**
         * An error occurred and completed the compilation
         */
        error: {
          type: Boolean,
          value: false,
          notify: true
        },
        /**
         * Log to console
         */
        debug: {
          type: Boolean,
          value: false,
          notify: true
        }
      },
      _observeSource: function () {
        if (!this.running && this.source != '') {
          var source = this.source
          this.fire('start', source)
          this.running = true
          this.error = false
          this.log = ''
          var pdftex = new PDFTeX(this.pdftexWorkerPath)
          var self = this
          var processNext = function processNext () {
            if (self.source !== source) {
              self._observeSource
            }
          }
          pdftex.set_TOTAL_MEMORY(80*1024*1024).then(function () {
            var logOutput = function logOutput (log) {
              if (self.debug) {
                console.log(log)
              }
              self.fire('log', log)
              self.log += log + '\n'
              if (log.indexOf('Emergency stop') >= 0) {
                // an error occured
                self.error = true
                self.running = false
                self.fire('error', 'Emergency stop!')
                processNext()
              }
            }
            pdftex.on_stdout = logOutput
            pdftex.on_stderr = logOutput

            pdftex.compile(source).then(function(pdfUrl) {
              self.pdf = pdfUrl
              self.running = false
              self.fire('complete', pdfUrl)
              processNext()
            })
          })
        }
      }
      /**
       * Fired when compilation successfully terminated.
       *
       * @event complete
       * @param {String} pdfUrl Url to pdf
       */
      /**
       * Fired when pdftex logs a message (the complete log is available in the `log` property)
       *
       * @event log
       * @param {String} pdfUrl The log message
       */
      /**
       * Fired when compilation successfully terminated.
       *
       * @event error
       * @param {String} message Error message
       */
      /**
       * Fired when compilation started.
       *
       * @event start
       * @param {String} source Compilation source
       */
    })
  </script>
</dom-module>
